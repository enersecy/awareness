var Status;var Icons={Succeeded:"iconStatusSucceeded",Failed:"iconStatusFailed",Warning:"iconStatusWarning"};var _InstrumentList=["microsoft.com"];var _EnableClientInstrument=true;function LoadStrings(){var strings=getLocaleStrings(ReportMessageStrings,Office.context.displayLanguage);Status={ReportJunkSucceeded:{name:"ReportJunkSucceeded",message:strings.ReportJunkSucceeded,icon:Icons.Succeeded},ReportPhishSucceeded:{name:"ReportPhishSucceeded",message:strings.ReportPhishSucceeded,icon:Icons.Succeeded},ReportNotJunkSucceeded:{name:"ReportNotJunkSucceeded",message:strings.ReportNotJunkSucceeded,icon:Icons.Succeeded},ReportFocusedFeedbackSucceeded:{name:"ReportFocusedFeedbackSucceeded",message:strings.ReportFocusedFeedbackSucceeded,icon:Icons.Succeeded},OptionsSaveSucceeded:{name:"OptionsSaveSucceeded",message:strings.OptionsSaveSucceeded,icon:Icons.Succeeded},OptionsSaveFailed:{name:"OptionsSaveFailed",message:strings.OptionsSaveFailed,icon:Icons.Failed},ReportJunkInJunk:{name:"ReportJunkInJunk",message:strings.ReportJunkInJunk,icon:Icons.Warning},ReportNotJunkInNotJunk:{name:"ReportNotJunkInNotJunk",message:strings.ReportNotJunkInNotJunk,icon:Icons.Warning},ReportFocusedFeedbackNotInInbox:{name:"ReportFocusedFeedbackNotInInbox",message:strings.ReportFocusedFeedbackNotInInbox,icon:Icons.Warning},CannotShowOptionsDialog:{name:"CannotShowOptionsDialog",message:strings.CannotShowOptionsDialog,icon:Icons.Warning},CannotShowHelpDialog:{name:"CannotShowHelpDialog",message:strings.CannotShowHelpDialog,icon:Icons.Warning},GetItemFailed:{name:"GetItemFailed",message:strings.GetItemFailed,icon:Icons.Failed},DoubleReportFailure:{name:"DoubleReportFailure",message:strings.DoubleReportFailure,icon:Icons.Warning},MaintenanceMode:{name:"MaintenanceMode",message:strings.MaintenanceMode,icon:Icons.Failed},DisabledMode:{name:"DisabledMode",message:"Report Message add-in has been disabled by your admin, please contact your admin for help.",icon:Icons.Warning},GeneralFailure:{name:"GeneralFailure",message:strings.GeneralFailure,icon:Icons.Failed},DelegatePermissionDenied:{name:"DelegatePermissionDenied",icon:Icons.Failed,message:"You do not have the write permission to this folder, please contact the owner to change the permission."},DelegateJunkFolderDenied:{name:"DelegateJunkFolderDenied",icon:Icons.Failed,message:"You do not have the write permission of Junk Mail folder to complete this action, please contact the owner to change the permission."},DelegateDeletedFolderDenied:{name:"DelegateDeletedFolderDenied",icon:Icons.Failed,message:"You do not have the write permission of Deleted Items folder to complete this action, please contact the owner to change the permission."},DelegateIndexFolderDenied:{name:"DelegateIndexFolderDenied",icon:Icons.Failed,message:"You do not have the write permission of Index folder to complete this action, please contact the owner to change the permission."}}}(function($){$.fn.filterNode=function(node){return this.find("*").filter(function(){return this.nodeName===node})}})(jQuery);(function($){$.QueryString=function(a){if(a==="")return{};var b={};for(var i=0;i<a.length;++i){var p=a[i].split("=");if(p.length!==2)continue;b[p[0]]=decodeURIComponent(p[1].replace(/\+/g," "))}return b}(window.location.search.substr(1).split("&"))})(jQuery);if(!String.prototype.format){String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!=="undefined"?args[number]:match})}}if(!String.prototype.repeat){String.prototype.repeat=function(count){"use strict";if(this==null){throw new TypeError("can't convert "+this+" to object")}var str=""+this;count=+count;if(count!=count){count=0}if(count<0){throw new RangeError("repeat count must be non-negative")}if(count==Infinity){throw new RangeError("repeat count must be less than infinity")}count=Math.floor(count);if(str.length==0||count==0){return""}if(str.length*count>=1<<28){throw new RangeError("repeat count must not overflow maximum string size")}var rpt="";for(var i=0;i<count;i++){rpt+=str}return rpt}}if(!String.prototype.hashCode){String.prototype.hashCode=function(n){var hash=0,i=0,len=this.length;while(i<len){hash=(hash<<5)-hash+this.charCodeAt(i++)<<0}return("0".repeat(n-1)+(hash>>>0).toString(16)).substr(-n)}}var EntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return EntityMap[s]})}function updateStatus(status){var outlookMsgMaxLen=150;if(status&&status.message&&status.message.length+3>outlookMsgMaxLen){status.message=status.message.slice(0,outlookMsgMaxLen-3)+"..."}showNotificationMessage(status.message,status.icon).done(function(asyncResult){console.log("Showing notification message: "+status.message)}).fail(function(asyncResult){console.error("Showing notification message {0} failed with error {1}.".format(status.message,JSON.stringify(asyncResult)))}).always(function(asyncResult){ClientTraceEnd(TraceLevel.Info,Stage.End,status.name)})}function getLocaleStrings(strings,locale){var locStrings=strings["en-us"];if(locale===undefined){locale=$.QueryString.locale}if(locale===undefined&&Office.context!==undefined){locale=Office.context.displayLanguage}if(locale!==undefined&&locale!==null){locStrings=strings[locale.toLowerCase()]}if(locStrings===undefined){locStrings=strings["en-us"]}return locStrings}var TraceLevel={Error:"error",Warning:"warning",Info:"info"};var Stage={Begin:"b",GetToken:"tk",JunkAction:"act_j",PhishingAction:"act_p",NotJunkAction:"act_nj",FocusedFeedbackAction:"act_ff",OptionsAction:"act_o",HelpAction:"act_h",DialogLoading:"dlg_b",DialogLoaded:"dlg_e",DialogLoadFailed:"dlg_f",DialogMessageHandler:"dlg_mh",DialogEventHandler:"dlg_eh",WarmupBegin:"wu_b",WarmupEnd:"wu_e",GetItemBegin:"gi_b",GetItemEnd:"gi_e",GetItemError:"gi_err",ReportMessageBegin:"rm_b",ReportMessageEnd:"rm_e",ReportMessageError:"rm_err",GetItemMimeBegin:"gim_b",GetItemMimeEnd:"gim_e",GetItemMimeError:"gim_err",CreateMessageBegin:"cm_b",CreateMessageEnd:"cm_e",CreateMessageError:"cm_err",MarkAsJunkBegin:"maj_b",MarkAsJunkEnd:"maj_e",MarkAsJunkError:"maj_err",MoveMessageBegin:"mm_b",MoveMessageEnd:"mm_e",MoveMessageError:"mm_err",RestGetTokenBegin:"rest_tk_b",RestGetTokenEnd:"rest_tk_e",RestGetTokenError:"rest_tk_err",RestUpdateCustomPropertyBegin:"rest_cp_b",RestUpdateCustomPropertyEnd:"rest_cp_e",RestUpdateCustomPropertyError:"rest_cp_err",RestMoveMessageBegin:"rest_mm_b",RestMoveMessageEnd:"rest_mm_e",RestMoveMessageError:"rest_mm_err",RestReportBegin:"rest_rm_b",RestReportEnd:"rest_rm_e",RestReportError:"rest_rm_err",End:"e"};var _Perf={};var _Token;function idTokenCallback(asyncResult){$.post("/api/id",{perf:JSON.stringify(_Perf),token:asyncResult.value,user:Office.context.mailbox.userProfile.emailAddress,client:Office.context.mailbox.diagnostics.hostName,version:Office.context.mailbox.diagnostics.hostVersion}).done(function(data){_Token=data.key;_Perf[Stage.GetToken]=Date.now();console.info("Get token from Server: "+_Token)}).fail(function(jqxhr,textStatus,err){console.error("Post Token Request Failed: jqXHR {0}, textStatus {1}, err {2}.".format(JSON.stringify(jqxhr),textStatus,err))})}function ClientTrace(traceLevel,stage,message,promise){_Perf[stage]=Date.now();switch(traceLevel){case TraceLevel.Error:console.error(traceLevel+":"+stage+":"+message);break;case TraceLevel.Warning:console.warn(traceLevel+":"+stage+":"+message);break;case TraceLevel.Info:console.log(traceLevel+":"+stage+":"+message);break;default:console.warn("Unsupported trace level: "+traceLevel);break}if(!_EnableClientInstrument){return null}var obj={pf:_Perf,tk:_Token,msg:message};if(promise===true){return $.ajax({type:"POST",data:JSON.stringify(obj),url:"https://ipagave.azurewebsites.net/api/inst/"+traceLevel,contentType:"application/json"})}else{$.ajax({type:"POST",data:JSON.stringify(obj),url:"https://ipagave.azurewebsites.net/api/inst/"+traceLevel,contentType:"application/json"}).done(function(data){}).fail(function(jqxhr,textStatus,err){console.error("Post JSON Request Failed: jqXHR {0}, textStatus {1}, err {2}.".format(JSON.stringify(jqxhr),textStatus,err))})}}function ClientTraceEnd(traceLevel,stage,message){var promise=ClientTrace(traceLevel,stage,message,true);if(promise){promise.done(function(data){}).fail(function(jqxhr,textStatus,err){console.error("GetJSON Request Failed: jqXHR {0}, textStatus {1}, err {2}.".format(JSON.stringify(jqxhr),textStatus,err))}).always(function(){CompleteEvent()})}else{CompleteEvent()}}function CompleteEvent(){if(_clickEvent!==undefined){_clickEvent.completed()}}var _clickEvent;var _ReportAction;var _MaintenanceMode=false;var _SilentMode=false;var _DisabledList=[];var _TTL=1e3*3600*24*7;var _ReportFocusedFeedbackToMicrosoftAddress="focusedinboxdsatsubmission@service.microsoft.com";var Setting=function(settingName){this.name=settingName;try{var setting=Office.context.roamingSettings.get(settingName);if(setting===undefined||setting===null){this.value=undefined;this.ttl=undefined}else{this.value=setting.value;this.ttl=setting.ttl}}catch(e){this.value=undefined;this.ttl=undefined;console.log(e)}};Setting.prototype.expired=function(){if(this.value===undefined){return true}else{if(this.ttl===undefined||typeof this.ttl!=="number"){return false}else{return Number(new Date)>this.ttl}}};var SettingEntries={ReportMessageApiAvailable:"ReportMessageApiAvailable",RestReportMessageApiAvailable:"RestReportMessageApiAvailable",SpecificUserConfigurationApiAvailable:"SpecificUserConfigurationApiAvailable",AdminReportJunkEmailEnabled:"AdminReportJunkEmailEnabled",CheckForReportJunkDialog:"CheckForReportJunkDialog",ReportJunkSelected:"ReportJunkSelected"};var Settings;var Header=function(_header,_value){this.header=_header;this.value=_value};Header.prototype.header="";Header.prototype.value="";var TestFlight={f6695ea:true,dc10cb72:true,b133ef01:true,"9cf37618":true,aafa7481:true,bb24386d:true,afce9257:false,d8349dcf:false,default:true};var POLICY={};var FULL_POLICY={};var UserOption={ASK:1,AUTO:2,NEVER:4};var ReportActionName={ASK:"ask",AUTO:"auto",NEVER:"never"};var FOLDER_MAP={index:"Inbox",deleted:"DeletedItems",junk:"JunkEmail"};function getTargetFolderByAction(action){const lowerCaseAction=action.toLowerCase();switch(lowerCaseAction){case"junk":{return FOLDER_MAP.junk}case"phish":{return FOLDER_MAP.deleted}case"notjunk":{return FOLDER_MAP.index}case"policy":{return FOLDER_MAP.index}default:{return""}}}function checkIsDelegated(){return!!Office.context.mailbox.item.getSharedPropertiesAsync}function checkDelegatePermission(accessToken){var defer=$.Deferred();Office.context.mailbox.item.getSharedPropertiesAsync({asyncContext:accessToken},function(delegateAsyncResult){var shareProperties=delegateAsyncResult.value;var delegatePermissions=shareProperties.delegatePermissions;if((delegatePermissions&Office.MailboxEnums.DelegatePermissions.Write)!=0){defer.resolve(delegateAsyncResult)}else{defer.reject(Status.DelegatePermissionDenied)}});return defer.promise()}function checkDelegateFolders(restUrl,targetMailbox,delegateAccessToken,folder){var defer=$.Deferred();console.log("Delegate check folder:"+folder);$.ajax({type:"GET",url:restUrl+"/v2.0/users/"+targetMailbox+"/MailFolders/"+folder+"/childfolders",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+delegateAccessToken}}).then(function(){console.log("Delegate check folder success");defer.resolve()}).fail(function(error){console.error("Delegate check folder error");var status;switch(folder){case FOLDER_MAP.index:{status=Status.DelegateIndexFolderDenied;break}case FOLDER_MAP.junk:{status=Status.DelegateJunkFolderDenied;break}case FOLDER_MAP.deleted:{status=Status.DelegateDeletedFolderDenied;break}default:{status=Status.GeneralFailure}}defer.reject(status)});return defer.promise()}function reportDelegateItem(accessToken,action,ifReport){var defer=$.Deferred();var folder=getTargetFolderByAction(action);if(!folder){defer.reject(Status.GeneralFailure);return defer.promise()}var delegateAsyncResult_copy={};var itemRestId=getItemRestId();checkDelegatePermission(accessToken).then(function(delegateAsyncResult){delegateAsyncResult_copy=delegateAsyncResult;console.log(delegateAsyncResult_copy);return checkDelegateFolders(delegateAsyncResult.value.targetRestUrl||Office.context.mailbox.restUrl,delegateAsyncResult.value.targetMailbox,delegateAsyncResult.asyncContext,folder)}).then(function(){$.ajax({type:"POST",url:(delegateAsyncResult_copy.value.targetRestUrl||Office.context.mailbox.restUrl)+"/beta/users/"+delegateAsyncResult_copy.value.targetMailbox+"/messages/"+encodeURIComponent(itemRestId)+"/ReportMessage",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+delegateAsyncResult_copy.asyncContext},data:JSON.stringify({ReportAction:action,SubmitToMicrosoft:ifReport})}).done(defer.resolve).fail(function(jqXHR){var errorObj;try{errorObj=JSON.parse(jqXHR.responseText)}catch(e){errorObj={error:{code:-1}}}if(jqXHR.status===400&&!!errorObj.error&&errorObj.error.code==="RequestBroker-ParseUri"){defer.reject({message:jqXHR.responseText})}else{var errorJSONString=jqXHR.responseText;var error,code,message;try{error=JSON.parse(errorJSONString);code=error.error.code;message=error.error.message}catch(e){console.log("Parsing error response JSON failed: ",e);ClientTrace(TraceLevel.Error,Stage.RestReportError,"restReportItemAsync failed with JSON parsing error "+JSON.stringify(jqXHR));defer.reject({message:jqXHR.responseText});return}switch(code){case"InvalidOperationReportJunkInJunk":case"InvalidOperationReportNotJunkInNotJunk":case"InvalidOperationReportFromSentItems":case"InvalidOpeartionReportFromDeletedItems":updateStatus({name:code,message:message,icon:Icons.Warning});defer.resolve();break;default:console.log("Unknown error code: ",code);ClientTrace(TraceLevel.Error,Stage.RestReportError,"restReportItemAsync failed with Unkown error code "+JSON.stringify(jqXHR));defer.reject({message:jqXHR.responseText})}}})}).fail(function(status){defer.reject({status:status})});return defer.promise()}var _dialog;var _dialogDeferred;function openDialog(dlgName,msgBody,width,height){_dialogDeferred=$.Deferred();if(window.location===undefined||window.location.origin===undefined||window.location.pathname===undefined){var url="https://ipagave.azurewebsites.net/ReportMessage/FunctionFile.htm/"+dlgName}else{var url=window.location.origin+window.location.pathname+"/"+dlgName}_Perf[Stage.DialogLoading]=Date.now();console.log("Open dialog: "+url);if(width>100&&height>100){width=width*100/screen.width;height=height*100/screen.height}localStorage.setItem("policy",msgBody);Office.context.ui.displayDialogAsync(url,{width:width,height:height,displayInIframe:true},dialogCallback);return _dialogDeferred.promise()}function dialogCallback(asyncResult){console.log("Open dialog with status "+asyncResult.status);if(asyncResult.status==="failed"){ClientTrace(TraceLevel.Error,Stage.DialogLoaded,"Open dialog failed with error: "+JSON.stringify(asyncResult));_dialogDeferred.reject(asyncResult)}else{ClientTrace(TraceLevel.Info,Stage.DialogLoaded,"Open dialog successfully.");_dialog=asyncResult.value;var messageHandlerAdded=_dialog.addEventHandler(Microsoft.Office.WebExtension.EventType.DialogMessageReceived,messageHandler);console.log("Dialog message handler is added: "+messageHandlerAdded);var eventHandlerAdded=_dialog.addEventHandler(Microsoft.Office.WebExtension.EventType.DialogEventReceived,eventHandler);console.log("Dialog event handler is added: "+eventHandlerAdded);_dialogDeferred.resolve(asyncResult)}}function messageHandler(arg){console.log("Message is received from dialog: "+arg.message);_Perf[Stage.DialogMessageHandler]=Date.now();localStorage.removeItem("policy");_dialog.close();var params=JSON.parse(arg.message);if(params.source==="ReportingOptions"){if(params.action==="Save"){if(params.selected1==="auto"){Office.context.roamingSettings.set(SettingEntries.CheckForReportJunkDialog,{value:true,ttl:Number(new Date)+_TTL});Office.context.roamingSettings.set(SettingEntries.ReportJunkSelected,{value:true,ttl:Number(new Date)+_TTL})}else if(params.selected1==="never"){Office.context.roamingSettings.set(SettingEntries.CheckForReportJunkDialog,{value:true,ttl:Number(new Date)+_TTL});Office.context.roamingSettings.set(SettingEntries.ReportJunkSelected,{value:false,ttl:Number(new Date)+_TTL})}else{Office.context.roamingSettings.set(SettingEntries.CheckForReportJunkDialog,{value:false,ttl:Number(new Date)+_TTL});Office.context.roamingSettings.set(SettingEntries.ReportJunkSelected,{value:false,ttl:Number(new Date)+_TTL})}saveRoamingSettings().done(function(asyncResult){updateStatus(Status.OptionsSaveSucceeded)}).fail(function(asyncResult){updateStatus(Status.OptionsSaveFailed)}).always(function(asyncResult){})}else{CompleteEvent()}}if(params.source==="ReportingConfirmation"){if(params.notAgain===true){Office.context.roamingSettings.set(SettingEntries.CheckForReportJunkDialog,{value:true,ttl:Number(new Date)+_TTL});Office.context.roamingSettings.set(SettingEntries.ReportJunkSelected,{value:true,ttl:Number(new Date)+_TTL});saveRoamingSettings()}if(params.action==="Report"){actionWithReportOrNot(true)}else if(params.action==="Cancel"){CompleteEvent()}else{console.warn('With dialog source of "ReportingConfirmation", the action {0} is not supported. The action can only be "Report" or "Cancel".'.format(params.action));CompleteEvent()}}if(params.source==="Dialog"){CompleteEvent()}}function eventHandler(arg){_Perf[Stage.DialogEventHandler]=Date.now();var strings=getLocaleStrings(ReportMessageStrings,Office.context.displayLanguage);switch(arg.error){case 12002:updateStatus({name:"DialogError12002",message:strings.Error12002,icon:Icons.Failed});break;case 12003:updateStatus({name:"DialogError12003",message:strings.Error12003,icon:Icons.Failed});break;case 12004:updateStatus({name:"DialogError12004",message:strings.Error12004,icon:Icons.Failed});break;case 12005:updateStatus({name:"DialogError12005",message:strings.Error12005,icon:Icons.Failed});break;case 12006:ClientTraceEnd(TraceLevel.Info,Stage.End,"Dialog is closed");break;case 12007:updateStatus({name:"DialogError12007",message:strings.Error12007,icon:Icons.Failed});break;default:updateStatus({name:"OtherDialogError",message:"DialogEventHandler: "+arg.error,icon:Icons.Failed})}}function createSoapEnvelope(request){var result='<?xml version="1.0" encoding="utf-8"?>'+'<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+'               xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"'+'               xmlns:xsd="http://www.w3.org/2001/XMLSchema"'+'               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"'+'               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">'+"  <soap:Header>"+'     <t:RequestServerVersion Version="Exchange2013"/>'+"  </soap:Header>"+"  <soap:Body>"+request+"  </soap:Body>"+"</soap:Envelope>";return result}function getItemRequest(itemId){var result='    <GetItem xmlns="http://schemas.microsoft.com/exchange/services/2006/messages"'+'             xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">'+"      <ItemShape>"+"        <t:BaseShape>IdOnly</t:BaseShape>"+"        <t:AdditionalProperties>"+'          <t:ExtendedFieldURI PropertyTag="0x0E05" PropertyType="String" />';if(_ReportAction==="FocusedFeedback"){result=result+'          <t:ExtendedFieldURI PropertyTag="0x007D" PropertyType="String" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="InferenceClassificationTrackingEx" PropertyType="String" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="TriageFeatureVector" PropertyType="Binary" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="InferenceClassificationResult" PropertyType="Integer" />'+'          <t:ExtendedFieldURI  PropertyTag="0x1213" PropertyType="Integer" />'+'          <t:ExtendedFieldURI  PropertyTag="0x120E" PropertyType="Binary" />'+'          <t:ExtendedFieldURI  PropertyTag="0x120F" PropertyType="Binary" />'}result=result+"        </t:AdditionalProperties>"+"      </ItemShape>"+"      <ItemIds>"+'        <t:ItemId Id="'+itemId+'"/>'+"      </ItemIds>"+"    </GetItem>";return result}function getItemMimeContentRequest(itemId){var result='    <GetItem xmlns="http://schemas.microsoft.com/exchange/services/2006/messages"'+'           xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">'+"      <ItemShape>"+"        <t:BaseShape>IdOnly</t:BaseShape>"+"           <t:AdditionalProperties>"+'               <t:FieldURI FieldURI="item:MimeContent" />';if(_ReportAction==="FocusedFeedback"){result=result+'          <t:ExtendedFieldURI PropertyTag="0x0E05" PropertyType="String" />'+'          <t:ExtendedFieldURI PropertyTag="0x007D" PropertyType="String" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="InferenceClassificationTrackingEx" PropertyType="String" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="TriageFeatureVector" PropertyType="Binary" />'+'          <t:ExtendedFieldURI  PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="InferenceClassificationResult" PropertyType="Integer" />'+'          <t:ExtendedFieldURI  PropertyTag="0x1213" PropertyType="Integer" />'+'          <t:ExtendedFieldURI  PropertyTag="0x120E" PropertyType="Binary" />'+'          <t:ExtendedFieldURI  PropertyTag="0x120F" PropertyType="Binary" />'}result=result+"        </t:AdditionalProperties>"+"      </ItemShape>"+"      <ItemIds>"+'        <t:ItemId Id="'+itemId+'"/>'+"      </ItemIds>"+"    </GetItem>";return result}function createItemWithAttachmentRequest(addressesSoap,subject,body,attachmentName,mimeContent,item){var result='  <m:CreateItem MessageDisposition="SendOnly">'+"    <m:Items>"+"      <t:Message>"+"        <t:Subject>"+subject+"</t:Subject>"+'        <t:Body BodyType="HTML">'+body+"</t:Body>"+"        <t:Attachments>                                                          "+"          <t:ItemAttachment>                                                     "+"            <t:Name>"+attachmentName+"</t:Name>                             "+"            <t:IsInline>false</t:IsInline>                                       "+"            <t:Message>                                                          "+"              <t:ExtendedProperty>"+'                <t:ExtendedFieldURI PropertyTag="3591" PropertyType="Integer" />'+"                 <t:Value>1</t:Value>"+"              </t:ExtendedProperty>";if(_ReportAction==="FocusedFeedback"){if(item.inferenceClassification!=null){result=result+"              <t:ExtendedProperty>"+'                <t:ExtendedFieldURI PropertyTag="0x1213" PropertyType="Integer" />'+"                 <t:Value><![CDATA["+item.inferenceClassification+"]]></t:Value>"+"              </t:ExtendedProperty>"}if(item.inferenceClassificationTrackingEx!=null){result=result+"              <t:ExtendedProperty>"+'                <t:ExtendedFieldURI PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="InferenceClassificationTrackingEx" PropertyType="String" />'+"                 <t:Value><![CDATA["+item.inferenceClassificationTrackingEx+"]]></t:Value>"+"              </t:ExtendedProperty>"}if(item.triageFeatureVector!=null){result=result+"              <t:ExtendedProperty>"+'                <t:ExtendedFieldURI PropertySetId="23239608-685D-4732-9C55-4C95CB4E8E33" PropertyName="TriageFeatureVector" PropertyType="Binary" />'+"                 <t:Value><![CDATA["+item.triageFeatureVector+"]]></t:Value>"+"              </t:ExtendedProperty>"}}result=result+'              <t:MimeContent CharacterSet="UTF-8">'+mimeContent+"</t:MimeContent>"+"            </t:Message>                                                         "+"          </t:ItemAttachment>                                                    "+"        </t:Attachments>                                                         "+"        <t:ToRecipients>"+addressesSoap+"</t:ToRecipients>"+"      </t:Message>"+"    </m:Items>"+"  </m:CreateItem>";return result}function moveItemRequest(itemId,changeKey,folder){var result='    <MoveItem xmlns="http://schemas.microsoft.com/exchange/services/2006/messages"'+'              xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">'+"      <ToFolderId>"+'        <t:DistinguishedFolderId Id="'+folder+'"/>'+"      </ToFolderId>"+"      <ItemIds>"+'        <t:ItemId Id="'+itemId+'" ChangeKey="'+changeKey+'"/>'+"      </ItemIds>"+"    </MoveItem>";return result}function markAsJunkRequest(itemId,changeKey,isJunk,moveItem){var result='<m:MarkAsJunk IsJunk="'+isJunk+'" MoveItem="'+moveItem+'">'+"  <m:ItemIds>"+'    <t:ItemId Id="'+itemId+'" ChangeKey="'+changeKey+'" />'+"  </m:ItemIds>"+"</m:MarkAsJunk>";return result}function reportMessageRequest(itemId,changeKey,action,report){var result='    <m:ReportMessage ReportAction="{2}" BlockReportingToIPTeam="{3}">      <m:ItemIds>        <t:ItemId Id="{0}" ChangeKey="{1}" />      </m:ItemIds>    </m:ReportMessage>    '.format(itemId,changeKey,action,!report);return result}function callEws(envelope,context){var ewsDeferred=$.Deferred();if(context===undefined){context={}}$.extend(context,{defer:ewsDeferred});Office.context.mailbox.makeEwsRequestAsync(envelope,function(asyncResult){var asyncContext=asyncResult.asyncContext;if(asyncResult.status==="failed"){asyncContext.defer.reject(asyncResult)}else{if(asyncResult.value.indexOf(">NoError<")>=0){asyncContext.defer.resolve(asyncResult)}else{console.log("The request is failed with result: "+asyncResult.value);asyncContext.defer.reject(asyncResult)}}},context);return ewsDeferred.promise()}var _roamingSettingsDeferred;function saveRoamingSettings(){_roamingSettingsDeferred=$.Deferred();Office.context.roamingSettings.saveAsync(function(asyncResult){console.log("Settings are saved with status: "+asyncResult.status);if(asyncResult.status==="failed"){console.log("Settings are failed to save with error: "+JSON.stringify(asyncResult));_roamingSettingsDeferred.reject(asyncResult)}else{_roamingSettingsDeferred.resolve(asyncResult)}});return _roamingSettingsDeferred.promise()}function showNotificationMessage(msg,icon){var notificationMessageDeferred=$.Deferred();Office.context.mailbox.item.notificationMessages.replaceAsync("notifications",{icon:icon,type:"informationalMessage",message:msg,persistent:false},{asyncContext:notificationMessageDeferred},function(asyncResult){var context=asyncResult.asyncContext;if(asyncResult.status==="failed"){context.reject(asyncResult)}else{context.resolve(asyncResult)}});return notificationMessageDeferred.promise()}function ewsGetPolicy(){var defer=$.Deferred();ewsCheckFolder().done(function(item){var request=reportMessageRequest(Office.context.mailbox.item.itemId,item.changeKey,"GetPolicy",true);var envelope=createSoapEnvelope(request);callEws(envelope,item).done(function(result){console.log("Get policy success");console.log(result);var node=$.parseXML(result.value);var policyNodes=node.getElementsByTagName("m:Policy");if(policyNodes.length>0){var policyString=policyNodes[0].textContent;defer.resolve({Properties:[{Value:atob(policyString)}]})}else{defer.reject("No policy found")}}).fail(function(error){console.error("Get policy failed");console.error(error);defer.reject(error)})});return defer.promise()}function ewsReportMessageFlow(report){ewsCheckFolder().done(function(item){if(!report){ewsMarkAsJunk(item);return}_Perf[Stage.ReportMessageBegin]=Date.now();var request=reportMessageRequest(Office.context.mailbox.item.itemId,item.changeKey,_ReportAction,report);var envelope=createSoapEnvelope(request);callEws(envelope,item).done(function(asyncResult){console.log("ReportMessage {0} is successful.".format(Office.context.mailbox.item.itemId));if(Settings.ReportMessageApiAvailable.expired()){Office.context.roamingSettings.set(SettingEntries.ReportMessageApiAvailable,{value:true,ttl:undefined});saveRoamingSettings()}if(_ReportAction==="Junk"){updateStatus(Status.ReportJunkSucceeded)}else if(_ReportAction==="Phish"){updateStatus(Status.ReportPhishSucceeded)}else if(_ReportAction==="NotJunk"){updateStatus(Status.ReportNotJunkSucceeded)}}).fail(function(asyncResult){ClientTrace(TraceLevel.Error,Stage.ReportMessageError,"ReportMessage is failed with error "+JSON.stringify(asyncResult));if(Settings.ReportMessageApiAvailable.expired()){Office.context.roamingSettings.set(SettingEntries.ReportMessageApiAvailable,{value:false,ttl:Number(new Date)+_TTL});saveRoamingSettings();var msg="Reporting message is not supported by your Exchange server, moving the message ...";console.log(msg);showNotificationMessage(msg,Icons.Warning);ewsMarkAsJunk(asyncResult.asyncContext)}else{console.log("ReportMessage {0} is failed with error {1}.".format(Office.context.mailbox.item.itemId,asyncResult.error.message));updateStatus(Status.GeneralFailure)}}).always(function(asyncResult){_Perf[Stage.ReportMessageEnd]=Date.now();console.log("ReportMessage {0} is completed.".format(Office.context.mailbox.item.itemId))})})}function ewsCheckFolder(){var result=$.Deferred();_Perf[Stage.GetItemBegin]=Date.now();var request=getItemRequest(Office.context.mailbox.item.itemId);var envelope=createSoapEnvelope(request);callEws(envelope).done(function(asyncResult){_item=parseGetItemResponse(asyncResult.value);console.log("GetItem {0} is successful with key {1}.".format(Office.context.mailbox.item.itemId,_item.changeKey));if(_ReportAction==="FocusedFeedback"&&_item.folderName!=="Inbox"){updateStatus(Status.ReportFocusedFeedbackNotInInbox);result.reject()}else{result.resolve(_item)}}).fail(function(asyncResult){console.log("GetItem is failed with error {0}.".format(JSON.stringify(asyncResult)));ClientTrace(TraceLevel.Error,Stage.GetItemError,"GetItem is failed with error "+JSON.stringify(asyncResult));updateStatus(Status.DoubleReportFailure);result.reject()}).always(function(asyncResult){_Perf[Stage.GetItemEnd]=Date.now();console.log("GetItem {0} is completed.".format(Office.context.mailbox.item.itemId))});return result.promise()}function ewsReportFocusedFeedback(item){_Perf[Stage.GetItemMimeBegin]=Date.now();var request=getItemMimeContentRequest(Office.context.mailbox.item.itemId);var envelope=createSoapEnvelope(request);callEws(envelope,item).done(function(asyncResult){console.log("GetItemMimeContent {0} is successful.".format(Office.context.mailbox.item.itemId));var response=$.parseXML(asyncResult.value);var responseDom=$(response);var mimeContent=responseDom.filterNode("t:MimeContent")[0].textContent;updateStatus(Status.ReportFocusedFeedbackSucceeded);ewsCreateFocusedFeedbackMessage(asyncResult.asyncContext,mimeContent)}).fail(function(asyncResult){ClientTrace(TraceLevel.Error,Stage.GetItemMimeError,"GetItemMime is failed with error "+JSON.stringify(asyncResult))}).always(function(asyncResult){_Perf[Stage.GetItemMimeEnd]=Date.now();console.log("GetItemMimeContent {0} is completed.".format(Office.context.mailbox.item.itemId))})}function ewsCreateFocusedFeedbackMessage(item,mimeContent){var originalMessage={SubjectPrefix:"Report as FocusedFeedback",Subject:Office.context.mailbox.item.subject,From:Office.context.mailbox.item.from,To:Office.context.mailbox.item.to,Cc:Office.context.mailbox.item.cc,Bcc:Office.context.mailbox.item.bcc,OtherData:null};var toAddresses=_ReportFocusedFeedbackToMicrosoftAddress;originalMessage.OtherData="InferenceClassification:<br /><br />"+item.inferenceClassification+"<br /><br />"+"InferenceClassificationTrackingEx:<br /><br />"+item.triageFeatureVector+"<br /><br />"+"TriageFeatureVector:<br /><br />"+item.triageFeatureVector+"<br /><br />"+"Headers:<br /><br />"+item.headers;var addresses=toAddresses.split(";");var addressesSoap="";for(var address=0;address<addresses.length;address++){addressesSoap+="<t:Mailbox><t:EmailAddress>"+addresses[address]+"</t:EmailAddress></t:Mailbox>"}var subjectAndBody=composeSubjectAndBody(originalMessage);var request=createItemWithAttachmentRequest(addressesSoap,subjectAndBody.subject,subjectAndBody.body,"Original message",mimeContent,item);var envelope=createSoapEnvelope(request);_Perf[Stage.CreateMessageBegin]=Date.now();callEws(envelope,item).done(function(asyncResult){console.log("CreateItemWithAttachment {0} as {1} is successful.".format(Office.context.mailbox.item.itemId,_ReportAction))}).fail(function(asyncResult){ClientTrace(TraceLevel.Error,Stage.CreateMessageError,"CreateMessage is failed with error "+JSON.stringify(asyncResult))}).always(function(asyncResult){_Perf[Stage.CreateMessageEnd]=Date.now();console.log("CreateItemWithAttachment {0} is completed.".format(Office.context.mailbox.item.itemId));ewsHandleFocusedFeedback(asyncResult)})}function ewsHandleFocusedFeedback(asyncResult){if(asyncResult.status==="succeeded"){CompleteEvent()}else{updateStatus(Status.GeneralFailure)}}function ewsMarkAsJunk(item){if(_ReportAction==="Phish"){ewsMoveMessage(item);return}var isJunk=true;if(_ReportAction==="Junk"){isJunk=true}else if(_ReportAction==="NotJunk"){isJunk=false}_Perf[Stage.MarkAsJunkBegin]=Date.now();var request=markAsJunkRequest(Office.context.mailbox.item.itemId,item.changeKey,isJunk,true);var envelope=createSoapEnvelope(request);callEws(envelope,item).done(function(asyncResult){console.log("MarkAsJunk {0} as {1} is successful.".format(Office.context.mailbox.item.itemId,_ReportAction));if(_ReportAction==="Junk"){updateStatus(Status.ReportJunkSucceeded)}else if(_ReportAction==="NotJunk"){updateStatus(Status.ReportNotJunkSucceeded)}}).fail(function(asyncResult){ClientTrace(TraceLevel.Error,Stage.MarkAsJunkError,"MarkAsJunk is failed with error "+JSON.stringify(asyncResult));updateStatus(Status.GeneralFailure)}).always(function(asyncResult){_Perf[Stage.MarkAsJunkEnd]=Date.now();console.log("MarkAsJunk {0} is completed.".format(Office.context.mailbox.item.itemId));if(_clickEvent!==undefined){_clickEvent.completed()}})}function ewsMoveMessage(item){var request=moveItemRequest(Office.context.mailbox.item.itemId,item.changeKey,"deleteditems");var envelope=createSoapEnvelope(request);_Perf[Stage.MoveMessageBegin]=Date.now();callEws(envelope,item).done(function(asyncResult){console.log("MoveItem {0} is successful.".format(Office.context.mailbox.item.itemId));updateStatus(Status.ReportPhishSucceeded)}).fail(function(asyncResult){ClientTrace(TraceLevel.Error,Stage.MoveMessageError,"MoveMessage is failed with error "+JSON.stringify(asyncResult));updateStatus(Status.GeneralFailure)}).always(function(asyncResult){_Perf[Stage.MoveMessageEnd]=Date.now();console.log("MoveItem {0} is completed.".format(Office.context.mailbox.item.itemId));if(_clickEvent!==undefined){_clickEvent.completed()}})}function parseGetItemResponse(value){var itemId,changeKey,folderName,headers,folderReason,inferenceClassification,inferenceClassificationTrackingEx,triageFeatureVector;var response=$.parseXML(value);var responseDom=$(response);if(responseDom){var itemIdNode=responseDom.filterNode("t:ItemId")[0];itemId=itemIdNode.getAttribute("Id");changeKey=itemIdNode.getAttribute("ChangeKey");responseDom.find("t\\:ExtendedProperty").each(function(i,j){var propertyTag=$(j).find("t\\:ExtendedFieldURI").attr("PropertyTag");var textContent=j.textContent;if(propertyTag==="0x7d"){headers=textContent}else if(propertyTag==="0xe05"){folderName=textContent}else if(propertyTag==="0x1213"){inferenceClassification=textContent}else if(propertyTag===undefined){var propertyName=$(j).find("t\\:ExtendedFieldURI").attr("PropertyName");textContent=j.textContent;if(propertyName==="ItemCurrentFolderReason"){folderReason=textContent}else if(propertyName==="InferenceClassificationTrackingEx"){inferenceClassificationTrackingEx=textContent}else if(propertyName==="TriageFeatureVector"){triageFeatureVector=textContent}}});if(folderName===undefined){responseDom.find("ExtendedProperty").each(function(i,j){var propertyTag=$(j).find("ExtendedFieldURI").attr("PropertyTag");var textContent=j.textContent;if(propertyTag==="0x7d"){headers=textContent}else if(propertyTag==="0xe05"){folderName=textContent}else if(propertyTag==="0x1213"){inferenceClassification=textContent}else if(propertyTag===undefined){var propertyName=$(j).find("ExtendedFieldURI").attr("PropertyName");textContent=j.textContent;if(propertyName==="ItemCurrentFolderReason"){folderReason=textContent}else if(propertyName==="InferenceClassificationTrackingEx"){inferenceClassificationTrackingEx=textContent}else if(propertyName==="TriageFeatureVector"){triageFeatureVector=textContent}}})}}return{itemId:itemId,changeKey:changeKey,folderName:folderName,headers:headers,folderReason:folderReason,inferenceClassification:inferenceClassification,inferenceClassificationTrackingEx:inferenceClassificationTrackingEx,triageFeatureVector:triageFeatureVector}}function composeSubjectAndBody(originalMessage){var newSubject="["+originalMessage.SubjectPrefix+"]: "+originalMessage.Subject;var newBody="<style>td{border-left:1px solid black;border-top:1px solid black;}table{border-right:1px solid black;border-bottom:1px solid black;}</style>";newBody=newBody+"The user has reported this as a ";switch(_ReportAction){case"Phish":newBody=newBody+"phish";break;case"NotJunk":newBody=newBody+"not spam";break;case"FocusedFeedback":newBody=newBody+"Focused Inbox feedback";break;case"Junk":default:newBody=newBody+"spam";break}newBody=newBody+".<br><br>";newBody=newBody+"<b>Original Subject: </b>"+originalMessage.Subject+"<br>";newBody=newBody+"<b>Email From: </b>"+originalMessage.From.emailAddress+"<br>";newBody=newBody+"<b>Email To: </b>"+originalMessage.To.map(function(x){return x.emailAddress}).join("; ")+"<br>";newBody=newBody+"<b>Email Cc: </b>"+originalMessage.Cc.map(function(x){return x.emailAddress}).join("; ")+"<br>";if(originalMessage.OtherData!==undefined){newBody=newBody+"<b>Other comments: </b>"+originalMessage.OtherData+" <br>"}var subjectAndBody={};subjectAndBody.subject=newSubject;subjectAndBody.body=escapeHtml(newBody);return subjectAndBody}var _accessToken;function getAccessToken(){var option={isRest:true};var deffered=$.Deferred();Office.context.mailbox.getCallbackTokenAsync(option,function(asyncResult){if(asyncResult.status==="succeeded"){deffered.resolve(asyncResult.value)}else{deffered.reject(asyncResult)}});return deffered.promise()}function getLocaleStrings(strings,locale){var locStrings=strings["en-us"];if(locale===undefined){locale=$.QueryString.locale}if(locale===undefined&&Office.context!==undefined){locale=Office.context.displayLanguage}if(locale!==undefined&&locale!==null){locStrings=strings[locale.toLowerCase()]}if(locStrings===undefined){locStrings=strings["en-us"]}return locStrings}function getLocalizedActionType(reportAction){var strings=getLocaleStrings(ManifestStrings);if(reportAction==="Junk"){return strings.ReportAsJunkLabel}else if(reportAction==="Phish"){return strings.ReportAsPhishingLabel}else if(reportAction==="NotJunk"){return strings.ReportAsNotJunkLabel}else if(reportAction==="FocusedFeedback"){return strings.ReportFocusedFeedbackLabel}}function restReportMessage(action,report){var result=$.Deferred();var options={isRest:true};_Perf[Stage.RestGetTokenBegin]=Date.now();Office.context.mailbox.getCallbackTokenAsync(options,function(asyncResult){if(asyncResult.status==="succeeded"){_Perf[Stage.RestGetTokenEnd]=Date.now();_accessToken=asyncResult.value;_Perf[Stage.RestReportBegin]=Date.now();if(checkIsDelegated()){reportDelegateItem(_accessToken,action,report).done(function(ajaxResult){_Perf[Stage.RestReportEnd]=Date.now();if(action==="Junk"){updateStatus(Status.ReportJunkSucceeded)}else if(action==="Phish"){updateStatus(Status.ReportPhishSucceeded)}else if(action==="NotJunk"){updateStatus(Status.ReportNotJunkSucceeded)}result.resolve(JSON.stringify(ajaxResult))}).fail(function(error){if(error.status){updateStatus(error.status)}result.resolve(error.message)})}else{restReportItemAsync(_accessToken,action,report).done(function(ajaxResult){_Perf[Stage.RestReportEnd]=Date.now();if(report&&POLICY&&POLICY.PSME){if(action==="Junk"){updateStatus(Status.ReportJunkSucceeded)}else if(action==="Phish"){updateStatus(Status.ReportPhishSucceeded)}else if(action==="NotJunk"){updateStatus(Status.ReportNotJunkSucceeded)}}else{ClientTraceEnd(TraceLevel.Info,Stage.End,"ReportSucceeded")}result.resolve(JSON.stringify(ajaxResult))}).fail(function(jqXHR){var errorObj;try{errorObj=JSON.parse(jqXHR.responseText)}catch(e){errorObj={error:{code:-1}}}if(jqXHR.status===400&&!!errorObj.error&&errorObj.error.code==="RequestBroker-ParseUri"){result.reject(jqXHR.responseText)}else{var errorJSONString=jqXHR.responseText;var error,code,message;try{error=JSON.parse(errorJSONString);code=error.error.code;message=error.error.message}catch(e){console.log("Parsing error response JSON failed: ",e);ClientTrace(TraceLevel.Error,Stage.RestReportError,"restReportItemAsync failed with JSON parsing error "+JSON.stringify(jqXHR));result.reject(jqXHR.responseText);return}switch(code){case"InvalidOperationReportJunkInJunk":case"InvalidOperationReportNotJunkInNotJunk":case"InvalidOperationReportFromSentItems":case"InvalidOpeartionReportFromDeletedItems":updateStatus({name:code,message:message,icon:Icons.Warning});result.resolve(JSON.stringify(asyncResult));break;default:console.log("Unknown error code: ",code);ClientTrace(TraceLevel.Error,Stage.RestReportError,"restReportItemAsync failed with Unkown error code "+JSON.stringify(jqXHR));result.reject(jqXHR.responseText)}}})}}else{ClientTrace(TraceLevel.Error,Stage.RestGetTokenError,"GetCallbackTokenAsync is failed with error "+JSON.stringify(asyncResult));result.reject(JSON.stringify(asyncResult))}});return result.promise()}function convertPlatformValue(platform){switch(platform){case Office.PlatformType.Android:return"Android";case Office.PlatformType.iOS:return"iOS";case Office.PlatformType.Mac:return"Mac";case Office.PlatformType.OfficeOnline:return"OfficeOnline";case Office.PlatformType.PC:return"PC";case Office.PlatformType.Universal:return"Universal";default:return"Unknown"}}function restReportItemAsync(accessToken,action,report){var itemRestId=getItemRestId();var getMessageUrl=Office.context.mailbox.restUrl+"/beta/me/messages/"+encodeURIComponent(itemRestId)+"/ReportMessage";var clientPlatform=convertPlatformValue(Office.context.platform);return $.ajax({type:"POST",url:getMessageUrl,contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+accessToken},data:JSON.stringify({ReportAction:action,SubmitToMicrosoft:report,ClientPlatform:clientPlatform})})}function getItemRestId(){if(Office.context.mailbox.diagnostics.hostName==="OutlookIOS"){return Office.context.mailbox.item.itemId}else{return Office.context.mailbox.convertToRestId(Office.context.mailbox.item.itemId,Office.MailboxEnums.RestVersion.v2_0)}}function cmdJunk(event){CompleteEvent();_clickEvent=event;_ReportAction="Junk";try{ClientTrace(TraceLevel.Info,Stage.JunkAction,"Junk command started.");funcReportAction()}catch(e){var msg=JSON.stringify(e);ClientTrace(TraceLevel.Error,Stage.End,"Junk command ended, with exception: "+msg);CompleteEvent()}}function cmdPhishing(event){CompleteEvent();_clickEvent=event;_ReportAction="Phish";try{ClientTrace(TraceLevel.Info,Stage.PhishingAction,"Phishing command started.");funcReportAction()}catch(e){var msg=JSON.stringify(e);ClientTrace(TraceLevel.Error,Stage.End,"Phishing command ended, with exception: "+msg);CompleteEvent()}}function cmdNotJunk(event){CompleteEvent();_clickEvent=event;_ReportAction="NotJunk";try{ClientTrace(TraceLevel.Info,Stage.NotJunkAction,"NotJunk command started.");funcReportAction()}catch(e){var msg=JSON.stringify(e);ClientTrace(TraceLevel.Error,Stage.End,"NotJunk command ended, with exception: "+msg);CompleteEvent()}}function cmdFocusedFeedback(event){CompleteEvent();_clickEvent=event;_ReportAction="FocusedFeedback";try{ClientTrace(TraceLevel.Info,Stage.FocusedFeedbackAction,"FocusedFeedback command started.");funcReportAction()}catch(e){var msg=JSON.stringify(e);ClientTrace(TraceLevel.Error,Stage.End,"FocusedFeedback command ended, with exception: "+msg);CompleteEvent()}}function cmdOptions(event){CompleteEvent();_clickEvent=event;try{ClientTrace(TraceLevel.Info,Stage.OptionsAction,"Options command started.");funcOptions()}catch(e){var msg=JSON.stringify(e);ClientTrace(TraceLevel.Error,Stage.End,"Options command ended, with exception: "+msg);CompleteEvent()}}function cmdHelp(event){CompleteEvent();_clickEvent=event;try{funcHelp()}catch(e){console.log(JSON.stringify(e));CompleteEvent()}}function init(){if(!Office.context.ui.displayDialogAsync){_SilentMode=true}if(Settings===undefined){Settings={ReportMessageApiAvailable:new Setting(SettingEntries.ReportMessageApiAvailable),RestReportMessageApiAvailable:new Setting(SettingEntries.RestReportMessageApiAvailable),SpecificUserConfigurationApiAvailable:new Setting(SettingEntries.SpecificUserConfigurationApiAvailable),AdminReportJunkEmailEnabled:new Setting(SettingEntries.AdminReportJunkEmailEnabled),CheckForReportJunkDialog:new Setting(SettingEntries.CheckForReportJunkDialog),ReportJunkSelected:new Setting(SettingEntries.ReportJunkSelected)}}}var _item;function getPolicy(accessToken){if(Office.context.mailbox.restUrl){if(checkIsDelegated()){return reportDelegateItem(accessToken,"Policy",true)}else{return restReportItemAsync(accessToken,"Policy",true)}}else{return ewsGetPolicy()}}function funcReportAction(){if(_MaintenanceMode){updateStatus(Status.MaintenanceMode);return}if(_ReportAction!=="FocusedFeedback"){for(var i=0;i<_DisabledList.length;i++){if(Office.context.mailbox.userProfile.emailAddress.indexOf(_DisabledList[i])>0){updateStatus(Status.DisabledMode);return}}}if(_ReportAction!=="Junk"&&_ReportAction!=="NotJunk"&&_ReportAction!=="Phish"&&_ReportAction!=="FocusedFeedback"){console.warn("Report action type {0} is not supported.".format(_ReportAction));return}init();var report=getReportJunkToMicrosoft();getAccessToken().then(function(token){return getPolicy(token)}).then(function(result){if(result&&result.Properties&&result.Properties[0]){POLICY=JSON.parse(result.Properties[0].Value||"{}");if(result.Properties[1]){FULL_POLICY=JSON.parse(result.Properties[1].Value||"{}")}}}).always(function(){report=mergeUserSettingWithPolicy(report,FULL_POLICY);if(report==="ask"&&_SilentMode){report="never"}if(report==="ask"){openDialog("https://raw.githubusercontent.com/enersecy/reporter/main/src/ReportingConfirmation.html?reportAction={0}&locale={1}".format(encodeURIComponent(_ReportAction),Office.context.displayLanguage),JSON.stringify(POLICY),720,420).fail(function(asyncResult){actionWithReportOrNot(true)})}else{actionWithReportOrNot(true)}})}function actionWithReportOrNot(report){if(_ReportAction==="FocusedFeedback"){ewsCheckFolder().done(function(item){ewsReportFocusedFeedback(item)});return}if(CheckRestModeFlight()){restReportMessage(_ReportAction,report).fail(function(){ewsReportMessageFlow(report)})}else{ewsReportMessageFlow(report)}}function CheckRestModeFlight(){var userAddress=Office.context.mailbox.userProfile.emailAddress.toLowerCase();var userDomain=userAddress.substring(userAddress.indexOf("@")+1,userAddress.length);var userAccountHash=userAddress.hashCode();var userDomainHash=userDomain.hashCode();if(TestFlight[userAccountHash]!=null){return TestFlight[userAccountHash]}if(TestFlight[userDomainHash]!=null){return TestFlight[userDomainHash]}return TestFlight["default"]}function funcOptions(){init();if(_SilentMode){updateStatus(Status.CannotShowOptionsDialog);ClientTrace(TraceLevel.Info,Stage.End,"Options command ended, without showing Options dialog.")}else{getAccessToken().then(function(token){return getPolicy(token)}).then(function(result){if(result&&result.Properties&&result.Properties[0]){POLICY=JSON.parse(result.Properties[0].Value||"{}");if(result.Properties[1]){FULL_POLICY=JSON.parse(result.Properties[1].Value||"{}")}}}).always(function(){var reportJunkToMicrosoft=getReportJunkToMicrosoft();reportJunkToMicrosoft=mergeUserSettingWithPolicy(reportJunkToMicrosoft,FULL_POLICY);openDialog("https://raw.githubusercontent.com/enersecy/reporter/main/src/ReportingOptions.html?selected1={0}&locale={1}".format(reportJunkToMicrosoft,Office.context.displayLanguage),JSON.stringify(POLICY),720,420).done(function(asyncResult){}).fail(function(asyncResult){updateStatus(Status.CannotShowOptionsDialog)}).always(function(asyncResult){})})}}function funcHelp(){init();if(_SilentMode){updateStatus(Status.CannotShowHelpDialog)}else{var redir="https://aka.ms/ReportMessageFeedback";openDialog("https://raw.githubusercontent.com/enersecy/reporter/main/src/Dialog.html?redir={0}&locale={1}".format(encodeURIComponent(redir),Office.context.displayLanguage),undefined,80,80).done(function(asyncResult){}).fail(function(asyncResult){updateStatus(Status.CannotShowHelpDialog)}).always(function(asyncResult){})}}function getReportJunkToMicrosoft(){var reportJunkToMicrosoft="ask";if(Settings.CheckForReportJunkDialog.value===true&&Settings.ReportJunkSelected.value===true){reportJunkToMicrosoft="auto"}else if(Settings.CheckForReportJunkDialog.value===true&&Settings.ReportJunkSelected.value===false){reportJunkToMicrosoft="never"}return reportJunkToMicrosoft}function getReportNotJunkToMicrosoft(){var reportNotJunkToMicrosoft="ask";return reportNotJunkToMicrosoft}function isJunkEmailFolder(folderName){var name=folderName.toLowerCase();return name.indexOf("junk")>=0}function mergeUserSettingWithPolicy(userReportSetting,policySetting){if(userReportSetting===ReportActionName.NEVER){userReportSetting=ReportActionName.ASK}var preSubmitMsgEnabled=policySetting&&policySetting.isPreSubmitMessageEnabled;var tenantPolicyEnabled=policySetting&&policySetting.id;if(tenantPolicyEnabled&&!preSubmitMsgEnabled&&userReportSetting===ReportActionName.ASK){return ReportActionName.AUTO}else{return userReportSetting}}
